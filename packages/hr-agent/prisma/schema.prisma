generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Issue {
  id           Int      @id @default(autoincrement())
  issueId      Int      @unique
  issueUrl     String
  issueTitle   String
  issueContent String?  @db.Text
  createdAt    Int      @default(-2)
  updatedAt    Int      @default(-2)
  completedAt  Int      @default(-2)
  deletedAt    Int      @default(-2)
  tasks        Task[]
  issuePrs     IssuePR[]
  @@index([deletedAt])
}

model PullRequest {
  id          Int      @id @default(autoincrement())
  prId        Int      @unique
  prTitle     String
  prContent   String?  @db.Text
  prUrl       String
  issueId     Int?
  createdAt   Int      @default(-2)
  updatedAt   Int      @default(-2)
  completedAt Int      @default(-2)
  deletedAt   Int      @default(-2)
  tasks       Task[]
  issuePrs    IssuePR[]
  @@index([deletedAt])
}

model CodingAgent {
  id             Int              @id @default(autoincrement())
  caName         String           @unique
  containerId    String?
  status         String           @default("pending")
  dockerConfig   Json?
  createdAt      Int              @default(-2)
  updatedAt      Int              @default(-2)
  completedAt    Int              @default(-2)
  deletedAt      Int              @default(-2)
  tasks          Task[]
  logs           CodingAgentLog[]
  @@index([deletedAt])
  @@index([status])
}

model CodingAgentLog {
  id           Int      @id @default(autoincrement())
  caId         Int
  codingAgent  CodingAgent @relation(fields: [caId], references: [id])
  action       String
  oldValue     String?
  newValue     String?
  metadata     Json?
  createdAt    Int      @default(-2)
  @@index([caId])
  @@index([createdAt])
}

model Task {
  id           Int         @id @default(autoincrement())
  type         String
  status       String      @default("planned")
  priority     Int         @default(0)
  issueId      Int?
  issue        Issue?      @relation(fields: [issueId], references: [id])
  prId         Int?
  pullRequest  PullRequest? @relation(fields: [prId], references: [id])
  caId         Int?
  codingAgent  CodingAgent? @relation(fields: [caId], references: [id])
  metadata     Json?
  createdAt    Int         @default(-2)
  updatedAt    Int         @default(-2)
  completedAt  Int         @default(-2)
  deletedAt    Int         @default(-2)
  @@index([deletedAt])
  @@index([status])
  @@index([priority])
}

model IssuePR {
  id        Int          @id @default(autoincrement())
  issueId   Int
  prId      Int
  createdAt Int          @default(-2)
  issue     Issue        @relation(fields: [issueId], references: [id])
  pr        PullRequest  @relation(fields: [prId], references: [id])

  @@unique([issueId, prId])
  @@index([issueId])
  @@index([prId])
}
